# Base installation
The below steps install the foundation of my Arch Linux setup.
Most of the steps are copied from the [official Arch Wiki](https://wiki.archlinux.org/title/Installation_guide), with some customizations from my side.

## Preparations
Change the default keyboard layout:
````shell
loadkeys de
````

TODO: Internet connectivity?

## Partitions and filesystems
We will create two partitions:
- `EFI-Boot (fat32)`
- `LUKS-encrypted root (ext4)`

List block devices with `lsblk` then run `gdisk` to create the partitions:

````shell
gdisk /dev/<block-device>

Command: n
Partition number: 1
First sector: Enter
Last sector: +512M
Hex code or GUID: ef00

Command: n
Partition number: 2
First sector: Enter
Last sector: Enter
Hex code or GUID: 8309

Command: w
````

Create the filesystem for the EFI-boot partition:
````shell
mkfs.fat -F32 /dev/<efi-boot-partition>
````

Encrypt the root partition:
````shell
cryptsetup luksFormat /dev/<root-partition>
````

Open the encrypted partition:
````shell
cryptsetup luksOpen /dev/<encrypted-root-partition> cryptroot
````

Create the root partition filesytem:
````shell
mkfs.ext4 /dev/mapper/cryptroot
````

## Base system installation
First mount the previously created partitions:
````shell
mount /dev/mapper/cryptroot /mnt
mkdir /mnt/boot
mount -o uid=0,gid=0,umask=0077 /dev/<efi-boot-partition> /mnt/boot
````

Install the base system:
````shell
pacstrap /mnt base base-devel linux linux-firmware dosfstools dhcpcd vim man-db less
````

Generate the filesystem table
````shell
genfstab -U /mnt > /mnt/etc/fstab
````

Change-root into the new system
````shell
arch-chroot /mnt
````

Set the root password:
````shell
passwd
````

Set the hostname
````shell
echo <hostname> > /etc/hostname
````

## Locales and timezones
Generate locales:
````shell
echo LANG=en_US.UTF-8 > /etc/locale.conf
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
````

Set the console keyboard layout
````shell
echo KEYMAP=de-latin1 > /etc/vconsole.conf
````

Configure the timezone and setup NTP time synchronisation:
````shell
ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime
hwclock --systohc	# Sync hardware clock with system clock
systemctl enable systemd-timesyncd.service	# Enable NTP time synchronisation
````

## Kernel image
Configure the kernel image, edit: `/etc/mkinitcpio.conf`:
````shell
# Add ext4 to MODULES
MODULES = (ext4)

# Add the following hooks:
HOOKS=(base udev autodetect modconf block keyboard keymap encrypt filesystems fsck)
````
Build the kernel image:
````shell
mkinitcpio -P linux
````

## Bootloader setup

Install the bootloader 
````shell
bootctl --path=/boot install
````

We need to tell the bootloader where to look for the encrypted root partition. Use `blkid` to find the root partition UUID.

Copy the output of `blkid` to our bootloader configfile.
````shell
blkid > /boot/loader/entries/arch.conf
````

Configure the bootloader, edit: `/boot/loader/entries/arch.conf`
````shell
title    Arch Linux
linux    /vmlinuz-linux
initrd   /initramfs-linux.img
# cryptdevice must point to the encrypted root partition UUID that was generated by blkid.
# Dont use the UUID from /dev/mapper/cryptroot because this is the decrypted filesystem.
# Or in other words: Use the UUID of the partition with "TYPE=crypto_LUKS" :)
options  cryptdevice=UUID=<encrypted-root-partition-uuid>:cryptroot root=/dev/mapper/cryptroot rw lang=en init=/usr/lib/systemd/systemd locale=en_US.UTF-8
````

Make the bootloader aware of the config:
````shell
vim /boot/loader/loader.conf
timeout 3
default arch.conf
````

## Networkmanager
Install a networkmanager
````shell
pacman -S networkmanager
systemctl enable NetworkManager
````

## Swapfile
I am using a file-based swap, because its convinient to store it on my encrypted root partition:

Create a new swapfile (I prefer to use the RAM size or half the RAM size -> `free -h` -> `total`)
````shell
mkswap -U clear --size 8G --file /swapfile
````

Turn on the swap:
````shell
swapon /swapfile
````

Append an entry for the swapfile to the filesystem table:
````shell
echo "/swapfile none swap defaults 0 0" >> /etc/fstab
````

## Post-Installation
At this point you should have a working, minimal Arch Linux.

Reboot and make sure you can successfully boot, decrypt the root partition and login with `root`.
````shell
exit
umount -a
reboot
````

If you encounter issues you can boot from the live-iso and fix them with:
````shell
cryptsetup luksOpen /dev/<encrypted-root-partition> cryptroot
mount /dev/mapper/cryptroot /mnt
mount /dev/<efi-boot-partition> /mnt/boot
arch-chroot /mnt
```` 

### Create non-root user
````shell
useradd -m -G users,wheel <username>
passwd <username>   # Set user password.
````

### Allow users of group "wheel" to run sudo commands:
````shell
EDITOR=vim visudo 
# Uncomment this line
%wheel ALL=(ALL:ALL) ALL 
````

### Enable automatic mirrorlist updates
````shell
pacman -S reflector 
systemctl enable reflector.timer
````

### Install a firewall
````shell
pacamn -S ufw
ufw enable 
ufw status
````
